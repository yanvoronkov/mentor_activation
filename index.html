<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –°–∏—Å—Ç–µ–º–∞ - –î–µ—Ä–µ–≤–æ –ü–∞—Ä—Ç–Ω–µ—Ä–æ–≤</title>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			padding: 20px;
			color: #333;
		}

		.container {
			max-width: 1400px;
			margin: 0 auto;
		}

		.header {
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(10px);
			border-radius: 20px;
			padding: 30px;
			margin-bottom: 30px;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
			animation: slideDown 0.5s ease-out;
		}

		@keyframes slideDown {
			from {
				opacity: 0;
				transform: translateY(-30px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		h1 {
			text-align: center;
			font-size: 2.5rem;
			font-weight: 700;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
			margin-bottom: 20px;
		}

		.search-container {
			display: flex;
			gap: 15px;
			justify-content: center;
			flex-wrap: wrap;
		}

		.search-input {
			flex: 1;
			max-width: 400px;
			padding: 15px 20px;
			border: 2px solid #e0e0e0;
			border-radius: 12px;
			font-size: 1rem;
			transition: all 0.3s ease;
			outline: none;
		}

		.search-input:focus {
			border-color: #667eea;
			box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
		}

		.search-btn {
			padding: 15px 40px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border: none;
			border-radius: 12px;
			font-size: 1rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s ease;
			box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
		}

		.search-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
		}

		.search-btn:active {
			transform: translateY(0);
		}

		.loading {
			text-align: center;
			padding: 40px;
			color: white;
			font-size: 1.2rem;
		}

		.spinner {
			border: 4px solid rgba(255, 255, 255, 0.3);
			border-radius: 50%;
			border-top: 4px solid white;
			width: 40px;
			height: 40px;
			animation: spin 1s linear infinite;
			margin: 20px auto;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}

		.stats-container {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}

		.stat-card {
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(10px);
			border-radius: 15px;
			padding: 20px;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
			animation: fadeIn 0.5s ease-out;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: scale(0.9);
			}

			to {
				opacity: 1;
				transform: scale(1);
			}
		}

		.stat-label {
			font-size: 0.85rem;
			color: #666;
			font-weight: 500;
			margin-bottom: 8px;
		}

		.stat-value {
			font-size: 1.8rem;
			font-weight: 700;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}

		.tree-container {
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(10px);
			border-radius: 20px;
			padding: 30px;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
			animation: slideUp 0.5s ease-out;
		}

		@keyframes slideUp {
			from {
				opacity: 0;
				transform: translateY(30px);
			}

			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.level-header {
			display: flex;
			align-items: center;
			gap: 15px;
			padding: 20px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			border-radius: 12px;
			margin: 20px 0 15px;
			cursor: pointer;
			transition: all 0.3s ease;
			user-select: none;
		}

		.level-header:hover {
			transform: translateX(5px);
			box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
		}

		.level-header.level-2 {
			background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
			margin-left: 40px;
		}

		.level-icon {
			font-size: 1.5rem;
			transition: transform 0.3s ease;
		}

		.level-header.collapsed .level-icon {
			transform: rotate(-90deg);
		}

		.level-title {
			font-size: 1.2rem;
			font-weight: 600;
		}

		.level-count {
			margin-left: auto;
			background: rgba(255, 255, 255, 0.2);
			padding: 5px 15px;
			border-radius: 20px;
			font-size: 0.9rem;
		}

		.referral-card {
			background: white;
			border-radius: 12px;
			padding: 20px;
			margin: 10px 0;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
			transition: all 0.3s ease;
			border-left: 4px solid #667eea;
		}

		.referral-card.level-2 {
			margin-left: 40px;
			border-left-color: #f5576c;
		}

		.referral-card:hover {
			transform: translateX(5px);
			box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
		}

		.referral-header {
			display: flex;
			align-items: center;
			gap: 15px;
			margin-bottom: 15px;
			flex-wrap: wrap;
		}

		.user-icon {
			width: 50px;
			height: 50px;
			border-radius: 50%;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-weight: 600;
			font-size: 1.2rem;
		}

		.user-info {
			flex: 1;
			min-width: 200px;
		}

		.user-name {
			font-size: 1.1rem;
			font-weight: 600;
			color: #333;
			margin-bottom: 4px;
		}

		.user-nick {
			font-size: 0.9rem;
			color: #666;
		}

		.user-date {
			font-size: 0.85rem;
			color: #999;
			margin-left: auto;
		}

		.referral-stats {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			gap: 15px;
		}

		.stat-item {
			background: #f8f9fa;
			padding: 12px;
			border-radius: 8px;
		}

		.stat-item-label {
			font-size: 0.75rem;
			color: #666;
			margin-bottom: 4px;
		}

		.stat-item-value {
			font-size: 1rem;
			font-weight: 600;
			color: #333;
		}

		.stat-item-value.positive {
			color: #10b981;
		}

		.stat-item-value.negative {
			color: #ef4444;
		}

		.error-message {
			background: white;
			border-radius: 12px;
			padding: 30px;
			text-align: center;
			color: #ef4444;
			font-size: 1.1rem;
		}

		.empty-state {
			background: white;
			border-radius: 12px;
			padding: 60px 30px;
			text-align: center;
		}

		.empty-icon {
			font-size: 4rem;
			margin-bottom: 20px;
			opacity: 0.3;
		}

		.empty-text {
			font-size: 1.2rem;
			color: #999;
		}

		.hidden {
			display: none;
		}

		@media (max-width: 768px) {
			h1 {
				font-size: 1.8rem;
			}

			.header {
				padding: 20px;
			}

			.search-container {
				flex-direction: column;
			}

			.search-input {
				max-width: 100%;
			}

			.level-header.level-2,
			.referral-card.level-2 {
				margin-left: 0;
			}

			.referral-stats {
				grid-template-columns: repeat(2, 1fr);
			}
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="header">
			<h1>üåü –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –°–∏—Å—Ç–µ–º–∞</h1>
			<div class="search-container">
				<input type="text" id="searchInput" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, –Ω–∏–∫—É, ID...">
				<button id="loadAllBtn" class="search-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ—Ö</button>
			</div>
		</div>

		<div id="statsContainer" class="stats-container hidden"></div>
		<div id="treeContainer" class="tree-container hidden"></div>
		<div id="loadingContainer" class="loading hidden">
			<div class="spinner"></div>
			<div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
		</div>
	</div>

	<script>
		const API_URL = 'https://script.google.com/macros/s/AKfycbzk1S4ncdfE8e1oJfXfQrmmF1catY1T8CFxTDGUQLodVvNbtUUiEdkNHgQBESU_lWcQ/exec';

		// –ü–æ–ª—É—á–µ–Ω–∏–µ ID –∏–∑ URL
		function getIdFromURL() {
			const params = new URLSearchParams(window.location.search);
			return params.get('id');
		}

		// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã
		function showElement(id) {
			document.getElementById(id).classList.remove('hidden');
		}

		function hideElement(id) {
			document.getElementById(id).classList.add('hidden');
		}

		// –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç API
		function processAPIData(rawData, requestedUserId) {
			console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', requestedUserId);

			if (!Array.isArray(rawData) || rawData.length < 2) {
				console.warn('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö');
				return [];
			}

			// –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ - –∑–∞–≥–æ–ª–æ–≤–∫–∏, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—ë
			const headers = rawData[0];
			const rows = rawData.slice(1);

			console.log('–ó–∞–≥–æ–ª–æ–≤–∫–∏:', headers);
			console.log('–°—Ç—Ä–æ–∫ –¥–∞–Ω–Ω—ã—Ö:', rows.length);

			// –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å—ã –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
			const colMap = {
				referal_id: headers.indexOf('referal_id'),
				referalName: headers.indexOf('referalName'),
				referal_nickname: headers.indexOf('referal_nickname'),
				referer_id: headers.indexOf('referer_id'),
				referer_nickname: headers.indexOf('referer_nickname'),
				referer_name: headers.indexOf('referer_name'),
				reg_date: headers.indexOf('reg_date'),
				lev1: headers.indexOf('lev1'),
				lev2: headers.indexOf('lev2'),
				free_sprints: headers.indexOf('free_sprints'),
				total_bonus_points: headers.indexOf('total_bonus_points'),
				total_payment: headers.indexOf('total_payment'),
				total_earned: headers.indexOf('total_earned'),
				total_withdrawal: headers.indexOf('total_withdrawal'),
				balance: headers.indexOf('balance'),
				totalReferals: headers.indexOf('totalReferals')
			};

			const processedData = [];
			const userIdStr = String(requestedUserId);

			// –°–æ–±–∏—Ä–∞–µ–º ID –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è (–ø—Ä—è–º—ã–µ —Ä–µ—Ñ–µ—Ä–∞–ª—ã)
			const level1Ids = new Set();
			rows.forEach(row => {
				const refererId = String(row[colMap.referer_id]);
				const referalId = String(row[colMap.referal_id]);

				if (refererId === userIdStr && referalId !== userIdStr) {
					level1Ids.add(referalId);
				}
			});

			console.log('–†–µ—Ñ–µ—Ä–∞–ª—ã 1 —É—Ä–æ–≤–Ω—è:', Array.from(level1Ids));

			// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ–∫—É
			rows.forEach(row => {
				const referalId = String(row[colMap.referal_id]);
				const refererId = String(row[colMap.referer_id]);

				// –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∞–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
				if (referalId === userIdStr) {
					console.log('–ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
					return;
				}

				let level = 0;

				// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å
				if (refererId === userIdStr) {
					level = 1; // –ü—Ä—è–º–æ–π —Ä–µ—Ñ–µ—Ä–∞–ª
				} else if (level1Ids.has(refererId)) {
					level = 2; // –†–µ—Ñ–µ—Ä–∞–ª –≤—Ç–æ—Ä–æ–≥–æ —É—Ä–æ–≤–Ω—è
				}

				// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ 1 –∏ 2 —É—Ä–æ–≤–Ω—è
				if (level > 0) {
					// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ —á–∏—Å–ª–æ
					const toNum = (val) => {
						if (val === '' || val === null || val === undefined) return 0;
						const num = parseFloat(val);
						return isNaN(num) ? 0 : num;
					};

					// –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
					const formattedRow = [
						level,                                          // [0] —É—Ä–æ–≤–µ–Ω—å
						formatDate(row[colMap.reg_date]),              // [1] –¥–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
						row[colMap.referal_nickname] || '',            // [2] –Ω–∏–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
						row[colMap.referalName] || '',                 // [3] –∏–º—è
						row[colMap.referer_nickname] || '',            // [4] –Ω–∏–∫ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—è
						toNum(row[colMap.free_sprints]),               // [5] –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∑–∞–±–µ–≥–∏
						toNum(row[colMap.total_bonus_points]),         // [6] –±–æ–Ω—É—Å—ã
						toNum(row[colMap.total_payment]),              // [7] –≤—ã–ø–ª–∞—Ç—ã
						toNum(row[colMap.lev1]),                       // [8] —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ 1 —É—Ä–æ–≤–Ω—è
						toNum(row[colMap.lev2]),                       // [9] —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ 2 —É—Ä–æ–≤–Ω—è
						toNum(row[colMap.total_earned]),               // [10] –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ
						toNum(row[colMap.total_withdrawal]),           // [11] –≤—ã–≤–µ–¥–µ–Ω–æ
						toNum(row[colMap.balance]),                    // [12] –±–∞–ª–∞–Ω—Å
						toNum(row[colMap.totalReferals])               // [13] –≤—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
					];

					processedData.push(formattedRow);
				}
			});

			console.log('–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤:', processedData.length);
			console.log('–û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', processedData);

			return processedData;
		}

		// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
		function formatDate(dateString) {
			if (!dateString) return '';

			try {
				// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –¥–∞—Ç
				const date = new Date(dateString);
				if (isNaN(date.getTime())) return dateString;

				const year = date.getFullYear();
				const month = String(date.getMonth() + 1).padStart(2, '0');
				const day = String(date.getDate()).padStart(2, '0');

				return `${year}-${month}-${day}`;
			} catch (e) {
				return dateString;
			}
		}

		// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
		async function loadData(userId) {
			if (!userId) {
				alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
				return;
			}

			hideElement('statsContainer');
			hideElement('treeContainer');
			showElement('loadingContainer');

			try {
				const url = `${API_URL}?id=${encodeURIComponent(userId)}`;
				console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å URL:', url);

				const response = await fetch(url, {
					method: 'GET',
					redirect: 'follow'
				});

				console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);

				if (!response.ok) {
					throw new Error(`HTTP –æ—à–∏–±–∫–∞! –°—Ç–∞—Ç—É—Å: ${response.status}`);
				}

				const text = await response.text();
				console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', text.substring(0, 300));

				let data;
				try {
					data = JSON.parse(text);
				} catch (e) {
					console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:', e);
					throw new Error('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º JSON');
				}

				console.log('–î–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω—ã:', data);

				hideElement('loadingContainer');

				if (!Array.isArray(data) || data.length === 0) {
					showEmptyState();
					return;
				}

				// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º–∞—Ç–∞ API –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
				const processedData = processAPIData(data, userId);

				if (!processedData || processedData.length === 0) {
					showEmptyState();
					return;
				}

				displayData(processedData);

			} catch (error) {
				console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
				hideElement('loadingContainer');

				let errorHTML = '<div style="text-align: left; max-width: 800px; margin: 0 auto;">';
				errorHTML += '<h3 style="color: #ef4444; margin-bottom: 20px;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h3>';

				if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
					errorHTML += '<p><strong>–ü—Ä–æ–±–ª–µ–º–∞:</strong> –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Google Apps Script (CORS)</p>';
					errorHTML += '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 15px 0;">';
					errorHTML += '<p><strong>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ:</strong></p>';
					errorHTML += '<ol style="line-height: 1.8;">';
					errorHTML += '<li>–û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à Google Apps Script</li>';
					errorHTML += '<li>–ù–∞–∂–º–∏—Ç–µ <strong>"–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å"</strong> ‚Üí <strong>"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è–º–∏"</strong></li>';
					errorHTML += '<li>–°–æ–∑–¥–∞–π—Ç–µ <strong>"–ù–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ"</strong></li>';
					errorHTML += '<li>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø: <strong>"–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"</strong></li>';
					errorHTML += '<li>–ù–∞—Å—Ç—Ä–æ–π–∫–∏:</li>';
					errorHTML += '<ul>';
					errorHTML += '<li><strong>–í—ã–ø–æ–ª–Ω–∏—Ç—å –∫–∞–∫:</strong> –Ø (–≤–∞—à email)</li>';
					errorHTML += '<li><strong>–£ –∫–æ–≥–æ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø:</strong> <span style="color: #ef4444;">–í—Å–µ</span></li>';
					errorHTML += '</ul>';
					errorHTML += '<li>–ù–∞–∂–º–∏—Ç–µ <strong>"–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å"</strong></li>';
					errorHTML += '<li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ <strong>URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</strong> –∏ –æ–±–Ω–æ–≤–∏—Ç–µ –≤ –∫–æ–¥–µ</li>';
					errorHTML += '</ol>';
					errorHTML += '</div>';
					errorHTML += '<p style="margin-top: 20px;"><strong>–¢–∞–∫–∂–µ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –≤–∞—à–µ–º —Å–∫—Ä–∏–ø—Ç–µ –µ—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏—è doGet:</strong></p>';
					errorHTML += '<pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 8px; overflow-x: auto;">function doGet(e) {\n';
					errorHTML += '  var id = e.parameter.id;\n';
					errorHTML += '  // –≤–∞—à –∫–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö\n';
					errorHTML += '  var data = getReferralData(id);\n';
					errorHTML += '  \n';
					errorHTML += '  return ContentService\n';
					errorHTML += '    .createTextOutput(JSON.stringify(data))\n';
					errorHTML += '    .setMimeType(ContentService.MimeType.JSON);\n';
					errorHTML += '}</pre>';
					errorHTML += '<p style="margin-top: 15px; color: #666;">–¢–µ–∫—É—â–∏–π URL: <code style="background: #f1f1f1; padding: 2px 6px; border-radius: 3px;">' + API_URL + '</code></p>';
				} else {
					errorHTML += '<p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ:</strong> ' + error.message + '</p>';
				}

				errorHTML += '</div>';
				showError(errorHTML);
			}
		}

		// –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
		function displayStats(data) {
			const level1Count = data.filter(r => r[0] === 1).length;
			const level2Count = data.filter(r => r[0] === 2).length;
			const totalReferrals = level1Count + level2Count;

			// –ü–æ–¥—Å—á—ë—Ç –æ–±—â–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∫–∞ (–∫–æ–ª–æ–Ω–∫–∞ 10 - "–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ")
			const totalEarned = data.reduce((sum, r) => {
				const earned = parseFloat(r[10]) || 0;
				return sum + earned;
			}, 0);

			// –ü–æ–¥—Å—á—ë—Ç –æ–±—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ (–∫–æ–ª–æ–Ω–∫–∞ 12 - "–ë–∞–ª–∞–Ω—Å")
			const totalBalance = data.reduce((sum, r) => {
				const balance = parseFloat(r[12]) || 0;
				return sum + balance;
			}, 0);

			const statsHTML = `
				<div class="stat-card">
					<div class="stat-label">–í—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
					<div class="stat-value">${totalReferrals}</div>
				</div>
				<div class="stat-card">
					<div class="stat-label">–ü–∞—Ä—Ç–Ω–µ—Ä—ã 1 —É—Ä–æ–≤–Ω—è</div>
					<div class="stat-value">${level1Count}</div>
				</div>
				<div class="stat-card">
					<div class="stat-label">–ü–∞—Ä—Ç–Ω–µ—Ä—ã 2 —É—Ä–æ–≤–Ω—è</div>
					<div class="stat-value">${level2Count}</div>
				</div>
				<div class="stat-card">
					<div class="stat-label">–û–±—â–∏–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫</div>
					<div class="stat-value">${totalEarned.toFixed(2)}</div>
				</div>
				<div class="stat-card">
					<div class="stat-label">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
					<div class="stat-value">${totalBalance.toFixed(2)}</div>
				</div>
			`;

			document.getElementById('statsContainer').innerHTML = statsHTML;
			showElement('statsContainer');
		}

		// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
		let allReferralsData = [];

		// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–∞ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤
		function displayData(data) {
			// –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞
			allReferralsData = data;

			displayStats(data);

			const level1Data = data.filter(r => r[0] === 1);
			const level2Data = data.filter(r => r[0] === 2);

			let html = '';

			// –£—Ä–æ–≤–µ–Ω—å 1
			if (level1Data.length > 0) {
				html += `
					<div class="level-header" onclick="toggleLevel(1)">
						<span class="level-icon">‚ñº</span>
						<span class="level-title">–£—Ä–æ–≤–µ–Ω—å 1 - –ü—Ä—è–º—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä—ã</span>
						<span class="level-count">${level1Data.length}</span>
					</div>
					<div id="level-1-content">
						${level1Data.map(referral => createReferralCard(referral, 1)).join('')}
					</div>
				`;
			}

			// –£—Ä–æ–≤–µ–Ω—å 2
			if (level2Data.length > 0) {
				html += `
					<div class="level-header level-2" onclick="toggleLevel(2)">
						<span class="level-icon">‚ñº</span>
						<span class="level-title">–£—Ä–æ–≤–µ–Ω—å 2 - –ü–∞—Ä—Ç–Ω–µ—Ä—ã –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤</span>
						<span class="level-count">${level2Data.length}</span>
					</div>
					<div id="level-2-content">
						${level2Data.map(referral => createReferralCard(referral, 2)).join('')}
					</div>
				`;
			}

			document.getElementById('treeContainer').innerHTML = html;
			showElement('treeContainer');
		}

		// –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ä–µ—Ñ–µ—Ä–∞–ª–∞
		function createReferralCard(referral, level) {
			// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö: [—É—Ä–æ–≤–µ–Ω—å, –¥–∞—Ç–∞ —Ä–µ–≥., –Ω–∏–∫ —Ä–µ—Ñ–µ—Ä–∞–ª–∞, –∏–º—è, –Ω–∏–∫ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—è, –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∑–∞–±–µ–≥–∏, –±–æ–Ω—É—Å—ã, –≤—ã–ø–ª–∞—Ç—ã, 1 —É—Ä., 2 —É—Ä., –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ, –≤—ã–≤–µ–¥–µ–Ω–æ, –±–∞–ª–∞–Ω—Å, –≤—Å–µ–≥–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤]
			const [lvl, date, nick, name, inviterNick, freeRuns, bonuses, payouts, level1, level2, earned, withdrawn, balance, totalRefs] = referral;

			// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
			const formatValue = (val) => {
				if (val === '' || val === null || val === undefined) return '0';
				const num = parseFloat(val);
				return isNaN(num) ? '0' : (num % 1 === 0 ? num.toString() : num.toFixed(2));
			};

			const initial = (name || nick || '?').charAt(0).toUpperCase();

			return `
				<div class="referral-card level-${level}">
					<div class="referral-header">
						<div class="user-icon">${initial}</div>
						<div class="user-info">
							<div class="user-name">${name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
							<div class="user-nick">@${nick || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}</div>
						</div>
						<div class="user-date">üìÖ ${date || '–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
					</div>
					<div class="referral-stats">
						<div class="stat-item">
							<div class="stat-item-label">–ü—Ä–∏–≥–ª–∞—Å–∏–ª</div>
							<div class="stat-item-value">@${inviterNick || '-'}</div>
						</div>
						<div class="stat-item">
							<div class="stat-item-label">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –∑–∞–±–µ–≥–∏</div>
							<div class="stat-item-value">${formatValue(freeRuns)}</div>
						</div>
						<div class="stat-item">
							<div class="stat-item-label">–ë–æ–Ω—É—Å—ã</div>
							<div class="stat-item-value positive">${formatValue(bonuses)}</div>
						</div>
						<div class="stat-item">
							<div class="stat-item-label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
							<div class="stat-item-value positive">${formatValue(earned)}</div>
						</div>
						<div class="stat-item">
							<div class="stat-item-label">–í—ã–≤–µ–¥–µ–Ω–æ</div>
							<div class="stat-item-value">${formatValue(withdrawn)}</div>
						</div>
						<div class="stat-item">
							<div class="stat-item-label">–ë–∞–ª–∞–Ω—Å</div>
							<div class="stat-item-value positive">${formatValue(balance)}</div>
						</div>
						<div class="stat-item">
							<div class="stat-item-label">–í—ã–ø–ª–∞—Ç—ã</div>
							<div class="stat-item-value">${formatValue(payouts)}</div>
						</div>
					</div>
				</div>
			`;
		}

		// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —É—Ä–æ–≤–Ω—è
		function toggleLevel(level) {
			const content = document.getElementById(`level-${level}-content`);
			const headers = document.querySelectorAll('.level-header');

			headers.forEach(header => {
				if (header.textContent.includes(`–£—Ä–æ–≤–µ–Ω—å ${level}`)) {
					header.classList.toggle('collapsed');
				}
			});

			content.classList.toggle('hidden');
		}

		// –ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
		function showEmptyState() {
			document.getElementById('treeContainer').innerHTML = `
				<div class="empty-state">
					<div class="empty-icon">üîç</div>
					<div class="empty-text">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —ç—Ç–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</div>
				</div>
			`;
			showElement('treeContainer');
		}

		// –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
		function showError(message) {
			document.getElementById('treeContainer').innerHTML = `
				<div class="error-message">
					<div style="font-size: 3rem; margin-bottom: 15px;">‚ö†Ô∏è</div>
					<div>${message}</div>
				</div>
			`;
			showElement('treeContainer');
		}

		// –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º
		function searchReferrals(query) {
			if (!query || query.trim() === '') {
				// –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç–æ–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
				displayFilteredData(allReferralsData);
				return;
			}

			const searchTerm = query.toLowerCase().trim();

			// –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º –ø–æ–ª—è–º
			const filtered = allReferralsData.filter(referral => {
				const [level, date, nick, name, inviterNick, freeRuns, bonuses, payouts, level1, level2, earned, withdrawn, balance, totalRefs] = referral;

				// –ü–æ–∏—Å–∫ –ø–æ: –Ω–∏–∫—É, –∏–º–µ–Ω–∏, –ø—Ä–∏–≥–ª–∞—Å–∏—Ç–µ–ª—é
				return (
					(nick && nick.toLowerCase().includes(searchTerm)) ||
					(name && name.toLowerCase().includes(searchTerm)) ||
					(inviterNick && inviterNick.toLowerCase().includes(searchTerm)) ||
					(date && date.includes(searchTerm))
				);
			});

			console.log(`–ù–∞–π–¥–µ–Ω–æ ${filtered.length} —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${query}"`);

			if (filtered.length === 0) {
				hideElement('statsContainer');
				document.getElementById('treeContainer').innerHTML = `
					<div class="empty-state">
						<div class="empty-icon">üîç</div>
						<div class="empty-text">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${query}"</div>
					</div>
				`;
				showElement('treeContainer');
				return;
			}

			displayFilteredData(filtered);
		}

		// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ allReferralsData)
		function displayFilteredData(data) {
			displayStats(data);

			const level1Data = data.filter(r => r[0] === 1);
			const level2Data = data.filter(r => r[0] === 2);

			let html = '';

			// –£—Ä–æ–≤–µ–Ω—å 1
			if (level1Data.length > 0) {
				html += `
					<div class="level-header" onclick="toggleLevel(1)">
						<span class="level-icon">‚ñº</span>
						<span class="level-title">–£—Ä–æ–≤–µ–Ω—å 1 - –ü—Ä—è–º—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä—ã</span>
						<span class="level-count">${level1Data.length}</span>
					</div>
					<div id="level-1-content">
						${level1Data.map(referral => createReferralCard(referral, 1)).join('')}
					</div>
				`;
			}

			// –£—Ä–æ–≤–µ–Ω—å 2
			if (level2Data.length > 0) {
				html += `
					<div class="level-header level-2" onclick="toggleLevel(2)">
						<span class="level-icon">‚ñº</span>
						<span class="level-title">–£—Ä–æ–≤–µ–Ω—å 2 - –ü–∞—Ä—Ç–Ω–µ—Ä—ã –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤</span>
						<span class="level-count">${level2Data.length}</span>
					</div>
					<div id="level-2-content">
						${level2Data.map(referral => createReferralCard(referral, 2)).join('')}
					</div>
				`;
			}

			document.getElementById('treeContainer').innerHTML = html;
			showElement('treeContainer');
		}

		// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
		document.getElementById('loadAllBtn').addEventListener('click', () => {
			// –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
			document.getElementById('searchInput').value = '';
			// –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
			loadData('227290741');
		});

		document.getElementById('searchInput').addEventListener('input', (e) => {
			const query = e.target.value;
			// –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
			if (allReferralsData.length > 0) {
				searchReferrals(query);
			}
		});

		document.getElementById('searchInput').addEventListener('keypress', (e) => {
			if (e.key === 'Enter') {
				const query = e.target.value;
				if (allReferralsData.length > 0) {
					searchReferrals(query);
				} else {
					// –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
					loadData('227290741');
				}
			}
		});

		// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
		window.addEventListener('load', () => {
			const urlId = getIdFromURL();
			const userId = urlId || '227290741'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è ID 227290741
			loadData(userId);
		});
	</script>
</body>

</html>