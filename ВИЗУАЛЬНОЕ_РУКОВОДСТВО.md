# 🎯 Визуальное руководство: Что где менять при миграции

```
┌──────────────────────────────────────────────────────────────┐
│                    🔄 МИГРАЦИЯ ТАБЛИЦЫ                        │
└──────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│ 1️⃣  ПОЛУЧИТЬ ID НОВОЙ ТАБЛИЦЫ                                       │
└─────────────────────────────────────────────────────────────────────┘

   URL таблицы:
   https://docs.google.com/spreadsheets/d/ЗДЕСЬ_ID_ТАБЛИЦЫ/edit
                                          ↑──────────↑
                                       Скопировать это!


┌─────────────────────────────────────────────────────────────────────┐
│ 2️⃣  BACKEND: Заменить ID в 2 файлах                                 │
└─────────────────────────────────────────────────────────────────────┘

   📄 backend/doGet.gs
   ┌─────────────────────────────────────────────────────────────┐
   │ Строка 65:  function getReferralData() {                    │
   │   const spreadsheetId = 'СТАРЫЙ_ID';  ← ЗАМЕНИТЬ            │
   │                          ↓                                  │
   │   const spreadsheetId = 'НОВЫЙ_ID';  ← НА ЭТО              │
   │ }                                                           │
   └─────────────────────────────────────────────────────────────┘

   ┌─────────────────────────────────────────────────────────────┐
   │ Строка 73:  function getPaymentsData() {                    │
   │   const spreadsheetId = 'СТАРЫЙ_ID';  ← ЗАМЕНИТЬ            │
   │                          ↓                                  │
   │   const spreadsheetId = 'НОВЫЙ_ID';  ← НА ЭТО              │
   │ }                                                           │
   └─────────────────────────────────────────────────────────────┘

   ┌─────────────────────────────────────────────────────────────┐
   │ Строка 84:  function getBonusTransactionsData() {           │
   │   const spreadsheetId = 'СТАРЫЙ_ID';  ← ЗАМЕНИТЬ            │
   │                          ↓                                  │
   │   const spreadsheetId = 'НОВЫЙ_ID';  ← НА ЭТО              │
   │ }                                                           │
   └─────────────────────────────────────────────────────────────┘

   📄 backend/ssr_renderer.gs
   ┌─────────────────────────────────────────────────────────────┐
   │ Строка 14:  function doGetOld(e) {                          │
   │   const spreadsheetId = 'СТАРЫЙ_ID';  ← ЗАМЕНИТЬ            │
   │                          ↓                                  │
   │   const spreadsheetId = 'НОВЫЙ_ID';  ← НА ЭТО              │
   │ }                                                           │
   └─────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│ 3️⃣  РАЗВЕРТЫВАНИЕ: Создать новый Deployment в Google Apps Script    │
└─────────────────────────────────────────────────────────────────────┘

   Откройте новую таблицу:
   Extensions → Apps Script

   Скопируйте ВСЕ .gs файлы из папки backend/

   Нажмите: Deploy → New deployment

   ┌─────────────────────────────────────────────────────────────┐
   │ Настройки развертывания:                                    │
   │                                                             │
   │ Type:            Web app                                    │
   │ Execute as:      Me (ваш email)                            │
   │ Who has access:  Anyone                                     │
   │                                                             │
   │ [Deploy] ← Нажать                                          │
   └─────────────────────────────────────────────────────────────┘

   Скопируйте полученный URL:
   https://script.google.com/macros/s/НОВЫЙ_DEPLOYMENT_ID/exec
                                       ↑──────────────↑
                                    Скопировать это!


┌─────────────────────────────────────────────────────────────────────┐
│ 4️⃣  FRONTEND: Заменить Deployment URL                               │
└─────────────────────────────────────────────────────────────────────┘

   📄 docs/config.js
   ┌─────────────────────────────────────────────────────────────┐
   │ Строка 2:                                                   │
   │   const CONFIG = {                                          │
   │     API_URL: 'https://.../СТАРЫЙ_ID/exec',  ← ЗАМЕНИТЬ     │
   │               ↓                                             │
   │     API_URL: 'https://.../НОВЫЙ_ID/exec',   ← НА ЭТО       │
   │     DEFAULT_USER_ID: '227290741'                            │
   │   };                                                        │
   └─────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│ 5️⃣  ТРИГГЕРЫ: Настроить в новой таблице                             │
└─────────────────────────────────────────────────────────────────────┘

   В Apps Script редакторе:
   Нажать: Triggers (⏰ иконка слева)

   ┌─────────────────────────────────────────────────────────────┐
   │ ТРИГГЕР 1 (обязательный):                                   │
   │                                                             │
   │ Choose which function to run:    masterTrigger              │
   │ Select event source:              From spreadsheet          │
   │ Select event type:                On change                 │
   │                                                             │
   │ [Save] ← Нажать                                            │
   └─────────────────────────────────────────────────────────────┘

   ┌─────────────────────────────────────────────────────────────┐
   │ ТРИГГЕР 2 (для меню):                                       │
   │                                                             │
   │ Choose which function to run:    onOpen                     │
   │ Select event source:              From spreadsheet          │
   │ Select event type:                On open                   │
   │                                                             │
   │ [Save] ← Нажать                                            │
   └─────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│ 6️⃣  ПРОВЕРКА: Убедиться что все работает                            │
└─────────────────────────────────────────────────────────────────────┘

   В Apps Script редакторе запустить:

   ┌─────────────────────────────────────────────────────────────┐
   │ Function: testTableStructure           [▶ Run]              │
   │                                                             │
   │ Должно показать без ошибок:                                 │
   │ ✅ Тест 1: Листы существуют                                 │
   │ ℹ️ Заголовки referals: ...                                  │
   │ ℹ️ Участников в базе: ...                                   │
   └─────────────────────────────────────────────────────────────┘

   Откройте frontend (docs/index.html) в браузере:

   ┌─────────────────────────────────────────────────────────────┐
   │ ID пользователя: [227290741]         [Показать дерево]      │
   │                                                             │
   │ Должно загрузить данные без ошибок                          │
   └─────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────┐
│ ✅ ГОТОВО!                                                           │
└─────────────────────────────────────────────────────────────────────┘


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        АВТОМАТИЗАЦИЯ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Вместо ручной замены можно использовать скрипт:

$ ./replace_spreadsheet_id.sh НОВЫЙ_ID_ТАБЛИЦЫ
$ ./check_migration.sh

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                    ФАЙЛЫ, КОТОРЫЕ НЕ ТРОГАЕМ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Следующие файлы используют SpreadsheetApp.getActiveSpreadsheet()
и будут работать с новой таблицей автоматически:

✅ calculateMlmBonuses_trigger.gs
✅ calculateMonthlyBonus.gs
✅ updateReferalsTotals.gs
✅ masterTrigger.gs
✅ customMenu.gs
✅ autoIdAndDate.gs
✅ writeBonusTransaction.gs
✅ calculateReferralLevels.gs

Их НЕ нужно редактировать!

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                        ИТОГО К ИЗМЕНЕНИЮ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📝 Код (3 файла):
   backend/doGet.gs ............ 3 строки (65, 73, 84)
   backend/ssr_renderer.gs ..... 1 строка (14)
   docs/config.js .............. 1 строка (2)

⚙️ Настройки:
   Google Apps Script Deployment ... создать новый
   Триггеры ........................ настроить 2 шт

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Дата: 05.01.2026
```
