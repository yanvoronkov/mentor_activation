# 💰 MLM Бонусная Система - Инструкция

## 📋 Что было исправлено

### ✅ Критические исправления:

1. **Колонка `referal_name` (D)** - Теперь НЕ перезаписывается скриптом (заполняется вручную)
2. **Колонка `client_level` (E)** - Добавлена в таблицу payments, читается из нее напрямую
3. **18 колонок вместо 17** - Исправлена структура данных
4. **Индексы колонок** - Все сдвинуты на +1 позицию из-за новой колонки `transaction_time`

### 🛡️ Добавлена защита:

- ✅ Обработка всех возможных ошибок (try-catch)
- ✅ Проверка существования листов
- ✅ Валидация данных (пустые ID, неверные суммы)
- ✅ Детальное логирование каждого шага
- ✅ Пропуск пустых строк и уже обработанных платежей
- ✅ User-friendly уведомления с результатами
- ✅ Функция очистки данных для пересчета

---

## 📊 Структура таблиц

### Таблица "referals"

| # | Колонка | Что хранит |
|---|---------|------------|
| 0 | referal_id | Telegram ID участника |
| 1 | referalName | Имя и фамилия |
| 2 | referal_nickname | Никнейм Telegram |
| 3 | referal_level | Уровень партнера (1/2/3) |
| 4 | client_level | Уровень клиента (0/1/2) |
| 5 | referer_id | ID наставника |

### Таблица "payments"

| # | Колонка | Заполняет | Что хранит |
|---|---------|-----------|------------|
| 0 | transaction_id | 👤 Вручную | ID транзакции |
| 1 | transaction_time | 👤 Вручную | Дата/время |
| 2 | referal_id | 👤 Вручную | ID покупателя |
| 3 | **referal_name** | 👤 **Вручную** | Имя покупателя |
| 4 | **client_level** | 👤 **Вручную** | 1-новый, 2-повторный |
| 5 | product_id | 👤 Вручную | 1-спринт, 2-активация |
| 6 | payment | 👤 Вручную | Сумма платежа |
| 7 | referer_L1 | 🤖 Скрипт | ID наставника L1 |
| 8 | referer_L1_name | 🤖 Скрипт | Имя наставника L1 |
| 9 | referer_L1_level | 🤖 Скрипт | Уровень L1 |
| 10 | referer_L1_bonus | 🤖 Скрипт | Денежный бонус L1 |
| 11 | referer_L1_bonus_points | 🤖 Скрипт | Баллы L1 |
| 12 | referer_L2 | 🤖 Скрипт | ID наставника L2 |
| 13 | referer_L2_name | 🤖 Скрипт | Имя наставника L2 |
| 14 | referer_l2_level | 🤖 Скрипт | Уровень L2 |
| 15 | referer_L2_bonus | 🤖 Скрипт | Денежный бонус L2 |
| 16 | referer_L1_percent | 🤖 Скрипт | % комиссии L1 |
| 17 | referer_L2_percent | 🤖 Скрипт | % комиссии L2 |

---

## 🚀 Как использовать

### 1️⃣ Установка скрипта

1. Откройте вашу Google Таблицу
2. Перейдите: **Расширения → Apps Script**
3. Удалите весь старый код
4. Скопируйте содержимое файла `calculateMlmBonuses_fixed.gs`
5. Вставьте в редактор
6. Нажмите **Ctrl+S** (сохранить)
7. Закройте редактор и **обновите таблицу** (F5)

### 2️⃣ Использование

После установки в таблице появится новое меню: **💰 MLM Бонусы**

#### Добавление нового платежа:

1. В листе **payments** добавьте новую строку:
   - `transaction_id` - уникальный ID транзакции
   - `transaction_time` - дата и время
   - `referal_id` - ID покупателя из таблицы referals
   - `referal_name` - имя покупателя (вручную!)
   - `client_level` - 1 (новый) или 2 (повторная покупка)
   - `product_id` - 1 (спринт) или 2 (активация)
   - `payment` - сумма платежа

2. Нажмите: **💰 MLM Бонусы → 🚀 Рассчитать бонусы**

3. Скрипт автоматически заполнит колонки H-R с данными о бонусах

### 3️⃣ Пересчет бонусов

Если нужно пересчитать ВСЕ бонусы заново:

1. **💰 MLM Бонусы → 🗑️ Очистить все бонусы**
2. Подтвердите действие
3. **💰 MLM Бонусы → 🚀 Рассчитать бонусы**

---

## 💵 Логика расчета бонусов

### Настройки продуктов

```javascript
Продукт 1 (Спринт):      1 балл
Продукт 2 (Активация):   3 балла
```

### Бонусы для L1 (Прямой наставник)

#### Условие:
- Наставник должен быть **Партнером** (уровень 2+)

#### Баллы:
- Начисляются **ВСЕГДА** (согласно продукту)

#### Деньги:

| Тип клиента | Уровень наставника | Процент | Пример (1000₽) |
|-------------|-------------------|---------|----------------|
| **Новый (1)** | Партнер (2) | 10% | 100₽ |
| **Новый (1)** | ВИП (3+) | 15% | 150₽ |
| **Повторный (2)** | Любой (2+) | 5% | 50₽ |

### Бонусы для L2 (Дедушка)

#### Условия:
1. ✅ Клиент должен быть **НОВЫМ** (level=1)
2. ✅ У L1 есть свой наставник
3. ✅ L2 - **ВИП** (уровень 3+)

#### Бонус:
- **5%** от суммы покупки
- Баллы **НЕ** начисляются

---

## 📊 Примеры

### Пример 1: Новый клиент, Спринт (1000₽)

**Дано:**
- Покупатель: Ян Воронков (ID: 227783140) - **НОВЫЙ** (level=1)
- Наставник L1: Ян Воронков (ID: 227193871) - Партнер (level=2)
- Наставник L2: Марина Талько (ID: 227290741) - Партнер (level=2)
- Продукт: 1 (Спринт)
- Сумма: 100₽

**Результат:**

| Наставник | Уровень | Деньги | Баллы | % |
|-----------|---------|--------|-------|---|
| L1 (Ян) | 2 | 10₽ | 1 | 10% |
| L2 (Марина) | 2 | 0₽ | 0 | 0% |

❗ L2 не получает бонус, т.к. уровень 2 (нужен 3+)

### Пример 2: Новый клиент, Активация (2000₽)

**Дано:**
- Покупатель: Новый клиент (level=1)
- Наставник L1: ВИП (level=3)
- Наставник L2: ВИП (level=3)
- Продукт: 2 (Активация)
- Сумма: 2000₽

**Результат:**

| Наставник | Уровень | Деньги | Баллы | % |
|-----------|---------|--------|-------|---|
| L1 | 3 | 300₽ | 3 | 15% |
| L2 | 3 | 100₽ | 0 | 5% |

### Пример 3: Повторная покупка (500₽)

**Дано:**
- Покупатель: Повторный (level=2)
- Наставник L1: ВИП (level=3)
- Продукт: 1 (Спринт)
- Сумма: 500₽

**Результат:**

| Наставник | Уровень | Деньги | Баллы | % |
|-----------|---------|--------|-------|---|
| L1 | 3 | 25₽ | 1 | 5% |
| L2 | - | 0₽ | 0 | 0% |

❗ L2 не получает бонус при повторной покупке

---

## 🔍 Просмотр логов

Для отладки и проверки работы скрипта:

1. **Расширения → Apps Script**
2. Запустите функцию `calculateMlmBonuses`
3. Нажмите **Журнал выполнения** (слева)
4. Увидите подробный лог:

```
═══════════════════════════════════════════════════════
🚀 СТАРТ расчета MLM бонусов
═══════════════════════════════════════════════════════
✅ Листы найдены: payments, referals
📦 Продукты: 1, 2
👥 Загружено участников: 4
✅ Строка 2: L1=Ян Воронков | Бонус=10₽ (10%) + 1 б.
💾 СОХРАНЕНО изменений: 1
═══════════════════════════════════════════════════════
📊 СТАТИСТИКА:
   ✅ Обработано строк: 1
   ⏭️  Пропущено (уже обработаны): 1
   ⚠️  Ошибок/пропусков: 0
═══════════════════════════════════════════════════════
🎉 ЗАВЕРШЕНО
═══════════════════════════════════════════════════════
```

---

## ⚠️ Важные моменты

### ✅ Скрипт обрабатывает строки ТОЛЬКО ОДИН РАЗ

Проверка идет по колонке `H` (referer_L1):
- Если пустая → обрабатывается
- Если заполнена → пропускается

### 🔄 Для пересчета:

1. Используйте функцию **Очистить все бонусы**
2. Или вручную очистите колонки H-R

### 🛡️ Защита от ошибок:

- Пустые строки - пропускаются
- Несуществующий покупатель - показывается предупреждение
- Неверная сумма - пропускается с ошибкой
- Нет наставника - просто не начисляются бонусы

---

## 🆘 Что делать при ошибках

### "Лист не найден"
→ Проверьте названия листов: должны быть **payments** и **referals**

### "Покупатель не найден"
→ Убедитесь, что `referal_id` из payments есть в таблице referals

### "Некорректная сумма"
→ Проверьте, что в колонке `payment` число больше 0

### Бонусы не начисляются
→ Проверьте:
- У покупателя есть наставник в таблице referals
- Наставник имеет уровень 2+ (для L1) или 3+ (для L2)
- client_level указан правильно (1 или 2)

---

## 📞 Техническая поддержка

При возникновении проблем:

1. Проверьте **Журнал выполнения** в Apps Script
2. Убедитесь, что структура таблиц соответствует документации
3. Проверьте, что все обязательные колонки заполнены

---

**Версия скрипта:** 2.0  
**Дата:** 12.12.2025  
**Автор:** AI Assistant
