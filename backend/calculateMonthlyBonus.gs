/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Ğ ĞĞ¡Ğ§Ğ•Ğ¢ Ğ•Ğ–Ğ•ĞœĞ•Ğ¡Ğ¯Ğ§ĞĞ«Ğ¥ Ğ‘ĞĞĞ£Ğ¡ĞĞ’ Ğ—Ğ ĞĞšĞ¢Ğ˜Ğ’ĞĞĞ¡Ğ¢Ğ¬
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * Ğ’ĞµÑ€ÑĞ¸Ñ: 1.1 (Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¿Ğ¾Ğ´ÑÑ‡ĞµÑ‚Ğ°)
 * Ğ”Ğ°Ñ‚Ğ°: 22.12.2025
 * 
 * ĞĞĞ—ĞĞĞ§Ğ•ĞĞ˜Ğ•:
 * - ĞĞ°Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ±Ğ¾Ğ½ÑƒÑ Ğ¿Ğ°Ñ€Ñ‚Ğ½ĞµÑ€Ğ°Ğ¼ Ğ·Ğ° Ğ²Ñ‹ÑĞ¾ĞºÑƒÑ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒ
 * - Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ² ĞºĞ¾Ğ½Ñ†Ğµ Ğ¼ĞµÑÑÑ†Ğ° Ñ‡ĞµÑ€ĞµĞ· Ğ¼ĞµĞ½Ñ
 * 
 * Ğ£Ğ¡Ğ›ĞĞ’Ğ˜Ğ¯:
 * - ĞŸĞ¾Ñ€Ğ¾Ğ³: 9+ Ğ±Ğ¾Ğ½ÑƒÑĞ½Ñ‹Ñ… Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² Ğ·Ğ°Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾ Ğ·Ğ° Ğ¼ĞµÑÑÑ†
 * - Ğ‘Ğ¾Ğ½ÑƒÑ: 3% Ğ¾Ñ‚ Ğ²ÑĞµÑ… Ğ·Ğ°Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´ĞµĞ½ĞµĞ³ (bonus_amount) Ğ·Ğ° ÑÑ‚Ğ¾Ñ‚ Ğ¼ĞµÑÑÑ†
 * - ĞĞ°Ñ‡Ğ¸ÑĞ»ÑĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ´ĞµĞ½ÑŒĞ³Ğ°Ñ… (bonus_points = 0)
 * 
 * Ğ›ĞĞ“Ğ˜ĞšĞ:
 * 1. ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµÑ‚ bonus_transactions Ğ·Ğ° ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ğ¼ĞµÑÑÑ†
 * 2. Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ğ¾ Ğ¿Ğ°Ñ€Ñ‚Ğ½ĞµÑ€Ğ°Ğ¼ (referal_id)
 * 3. Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ Ğ±Ğ°Ğ»Ğ»Ñ‹ Ğ¸ Ğ´ĞµĞ½ÑŒĞ³Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ Ğ¿Ğ°Ñ€Ñ‚Ğ½ĞµÑ€Ğ°
 * 4. Ğ”Ğ»Ñ Ğ¿Ğ°Ñ€Ñ‚Ğ½ĞµÑ€Ğ¾Ğ² Ñ 9+ Ğ±Ğ°Ğ»Ğ»Ğ°Ğ¼Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ MO Ğ±Ğ¾Ğ½ÑƒÑ 3%
 */

/**
 * Ğ ĞĞ¡Ğ§Ğ•Ğ¢ Ğ•Ğ–Ğ•ĞœĞ•Ğ¡Ğ¯Ğ§ĞĞ«Ğ¥ Ğ‘ĞĞĞ£Ğ¡ĞĞ’ Ğ—Ğ ĞĞšĞ¢Ğ˜Ğ’ĞĞĞ¡Ğ¢Ğ¬
 * 
 * @param {string} month - ĞœĞµÑÑÑ† Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ YYYY-MM (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
 *                         Ğ•ÑĞ»Ğ¸ Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½ - Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ Ñ‡ĞµÑ€ĞµĞ· UI
 */
function calculateMonthlyBonus(month) {
  try {
    const startTime = new Date();
    Logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    Logger.log("ğŸ’° Ğ ĞĞ¡Ğ§Ğ•Ğ¢ Ğ•Ğ–Ğ•ĞœĞ•Ğ¡Ğ¯Ğ§ĞĞ«Ğ¥ Ğ‘ĞĞĞ£Ğ¡ĞĞ’");
    Logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    Logger.log("ğŸš€ Ğ¡Ñ‚Ğ°Ñ€Ñ‚: " + startTime.toLocaleString());
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const THRESHOLD_POINTS = 9;      // ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² Ğ·Ğ° Ğ¼ĞµÑÑÑ†
    const BONUS_PERCENT = 0.03;      // 3% Ğ¾Ñ‚ Ğ·Ğ°Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´ĞµĞ½ĞµĞ³
    
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const bonusSheet = ss.getSheetByName("bonus_transactions");
    const referalsSheet = ss.getSheetByName("referals");
    
    if (!bonusSheet || !referalsSheet) {
      Logger.log("âŒ ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹");
      return;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ĞĞŸĞ Ğ•Ğ”Ğ•Ğ›Ğ•ĞĞ˜Ğ• ĞœĞ•Ğ¡Ğ¯Ğ¦Ğ
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let targetMonth = month;
    
    // Ğ•ÑĞ»Ğ¸ Ğ¼ĞµÑÑÑ† Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½ - Ğ¾ÑˆĞ¸Ğ±ĞºĞ°
    if (!targetMonth) {
      const error = 'ĞœĞµÑÑÑ† Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ calculateMonthlyBonus("2025-12")';
      Logger.log("âŒ " + error);
      return;
    }
    
    // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ°
    if (!/^\d{4}-\d{2}$/.test(targetMonth)) {
      const error = 'ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¼ĞµÑÑÑ†Ğ°: ' + targetMonth + '. Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ YYYY-MM';
      Logger.log("âŒ " + error);
      return;
    }
    
    Logger.log("ğŸ“… Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ´Ğ»Ñ Ğ¼ĞµÑÑÑ†Ğ°: " + targetMonth);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ Ğ”ĞĞĞĞ«Ğ¥
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const lastRow = bonusSheet.getLastRow();
    if (lastRow < 2) {
      ui.alert('â„¹ï¸ ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…', 'Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° bonus_transactions Ğ¿ÑƒÑÑ‚Ğ°', ui.ButtonSet.OK);
      Logger.log("â„¹ï¸ Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° bonus_transactions Ğ¿ÑƒÑÑ‚Ğ°");
      return;
    }
    
    const bonusData = bonusSheet.getRange(2, 1, lastRow - 1, 16).getValues();
    
    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° referals Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ¼ĞµĞ½
    const referalsData = referalsSheet.getRange(2, 1, referalsSheet.getLastRow() - 1, 5).getValues();
    const referalsMap = {};
    referalsData.forEach(row => {
      referalsMap[String(row[0]).trim()] = String(row[1]).trim(); // ID -> Name
    });
    
    Logger.log("ğŸ“Š Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ğ±Ğ¾Ğ½ÑƒÑĞ¾Ğ²: " + bonusData.length);
    Logger.log("ğŸ‘¥ Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ğ¿Ğ°Ñ€Ñ‚Ğ½ĞµÑ€Ğ¾Ğ²: " + Object.keys(referalsMap).length);
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ğ“Ğ Ğ£ĞŸĞŸĞ˜Ğ ĞĞ’ĞšĞ ĞŸĞ ĞŸĞĞ Ğ¢ĞĞ•Ğ ĞĞœ Ğ—Ğ ĞœĞ•Ğ¡Ğ¯Ğ¦
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const partnerStats = {};
    let processedBonuses = 0;
    let skippedBonuses = 0;
    
    Logger.log("\nğŸ” ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ±Ğ¾Ğ½ÑƒÑĞ¾Ğ² Ğ·Ğ° " + targetMonth + ":");
    
    for (let i = 0; i < bonusData.length; i++) {
      const createdAt = String(bonusData[i][14]).trim();    // O: created_at
      const status = String(bonusData[i][15]).trim();       // P: status
      const bonusLevel = String(bonusData[i][5]).trim();    // F: bonus_level
      
      // ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¾Ñ‚Ğ¼ĞµĞ½ĞµĞ½Ğ½Ñ‹Ğµ Ğ¸ ÑÑ‚Ğ¾Ñ€Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ
      if (status === "cancelled" || status === "reversed") {
        skippedBonuses++;
        continue;
      }
      
      // ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑƒĞ¶Ğµ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ¼ĞµÑÑÑ‡Ğ½Ñ‹Ğµ Ğ±Ğ¾Ğ½ÑƒÑÑ‹
      if (bonusLevel === "MO") {
        skippedBonuses++;
        continue;
      }
      
      // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ - Ğ¾Ñ‚Ğ½Ğ¾ÑĞ¸Ñ‚ÑÑ Ğ»Ğ¸ Ğº Ğ½ÑƒĞ¶Ğ½Ğ¾Ğ¼Ñƒ Ğ¼ĞµÑÑÑ†Ñƒ
      let recordMonth = "";
      
      // ĞŸĞ¾Ğ¿Ñ‹Ñ‚ĞºĞ° Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¾Ğ²
      if (bonusData[i][14] instanceof Date) {
        // Google Sheets Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Date Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
        const date = bonusData[i][14];
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        recordMonth = year + "-" + month;
      } else if (createdAt.includes(".")) {
        // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: 22.12.2025 16:38:03 Ğ¸Ğ»Ğ¸ 22.12.2025
        const parts = createdAt.split(" ")[0].split(".");
        if (parts.length === 3) {
          const day = parts[0];
          const month = parts[1];
          const year = parts[2];
          recordMonth = year + "-" + month; // 2025-12
        }
      } else if (createdAt.includes("-")) {
        // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ ISO: 2025-12-22
        recordMonth = createdAt.substring(0, 7); // 2025-12
      } else if (!isNaN(createdAt) && createdAt.length > 0) {
        // Timestamp
        const timestamp = parseFloat(createdAt);
        if (timestamp > 0) {
          const date = new Date(timestamp);
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          recordMonth = year + "-" + month;
        }
      } else if (createdAt.includes("GMT")) {
        // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: "Mon Dec 22 2025 17:59:15 GMT+0300"
        const date = new Date(createdAt);
        if (!isNaN(date.getTime())) {
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          recordMonth = year + "-" + month;
        }
      }
      
      if (!recordMonth) {
        Logger.log(`âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ñ€Ğ°ÑĞ¿Ğ°Ñ€ÑĞ¸Ñ‚ÑŒ Ğ´Ğ°Ñ‚Ñƒ: "${createdAt}" (ÑÑ‚Ñ€Ğ¾ĞºĞ° ${i + 2})`);
        skippedBonuses++;
        continue;
      }
      
      if (recordMonth !== targetMonth) {
        skippedBonuses++;
        continue; // ĞĞµ Ñ‚Ğ¾Ñ‚ Ğ¼ĞµÑÑÑ†
      }
      
      // Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ
      const referalId = String(bonusData[i][2]).trim();     // C: referal_id
      const bonusAmount = parseFloat(bonusData[i][6]) || 0; // G: bonus_amount
      const bonusPoints = parseFloat(bonusData[i][7]) || 0; // H: bonus_points
      
      if (!partnerStats[referalId]) {
        partnerStats[referalId] = {
          name: referalsMap[referalId] || "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹",
          totalPoints: 0,
          totalAmount: 0,
          bonusCount: 0
        };
      }
      
      partnerStats[referalId].totalPoints += bonusPoints;
      partnerStats[referalId].totalAmount += bonusAmount;
      partnerStats[referalId].bonusCount++;
      processedBonuses++;
    }
    
    Logger.log(`ğŸ“Š Ğ’ÑĞµĞ³Ğ¾ Ğ±Ğ¾Ğ½ÑƒÑĞ¾Ğ²: ${bonusData.length}`);
    Logger.log(`âœ… ĞŸĞ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ… Ğ·Ğ° ${targetMonth}: ${processedBonuses}`);
    Logger.log(`â­ï¸  ĞŸÑ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾: ${skippedBonuses}`);
    Logger.log(`ğŸ‘¥ ĞŸĞ°Ñ€Ñ‚Ğ½ĞµÑ€Ğ¾Ğ² Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒÑ: ${Object.keys(partnerStats).length}`);
    
    // ĞÑ‚Ğ»Ğ°Ğ´Ğ¾Ñ‡Ğ½Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
    Logger.log("\nğŸ“‹ Ğ’Ğ¡Ğ• ĞŸĞĞ Ğ¢ĞĞ•Ğ Ğ« Ğ¡ ĞĞšĞ¢Ğ˜Ğ’ĞĞĞ¡Ğ¢Ğ¬Ğ®:");
    for (const partnerId in partnerStats) {
      const stats = partnerStats[partnerId];
      Logger.log(`  ${stats.name} (${partnerId}): ${stats.totalPoints} Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ², ${stats.totalAmount.toFixed(2)}â‚½, Ğ±Ğ¾Ğ½ÑƒÑĞ¾Ğ²: ${stats.bonusCount}`);
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ Ğ£Ğ–Ğ• ĞĞĞ§Ğ˜Ğ¡Ğ›Ğ•ĞĞĞ«Ğ¥ ĞœĞ•Ğ¡Ğ¯Ğ§ĞĞ«Ğ¥ Ğ‘ĞĞĞ£Ğ¡ĞĞ’
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const existingMonthlyBonuses = new Set();
    
    for (let i = 0; i < bonusData.length; i++) {
      const bonusLevel = String(bonusData[i][5]).trim();    // F: bonus_level
      const transactionId = String(bonusData[i][1]).trim(); // B: transaction_id (Ğ±Ñ‹Ğ»Ğ¾ A!)
      
      if (bonusLevel === "MO" && transactionId.startsWith(`MO-${targetMonth}-`)) {
        existingMonthlyBonuses.add(transactionId);
      }
    }
    
    if (existingMonthlyBonuses.size > 0) {
      Logger.log(`\nâš ï¸ ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ ÑƒĞ¶Ğµ Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ½Ñ‹Ñ… Ğ¼ĞµÑÑÑ‡Ğ½Ñ‹Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ¾Ğ² Ğ·Ğ° ${targetMonth}: ${existingMonthlyBonuses.size}`);
      existingMonthlyBonuses.forEach(id => Logger.log(`  - ${id}`));
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ğ ĞĞ¡Ğ§Ğ•Ğ¢ Ğ˜ ĞĞĞ§Ğ˜Ğ¡Ğ›Ğ•ĞĞ˜Ğ• ĞœĞ•Ğ¡Ğ¯Ğ§ĞĞ«Ğ¥ Ğ‘ĞĞĞ£Ğ¡ĞĞ’
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let eligibleCount = 0;
    let bonusesCreated = 0;
    let totalMonthlyBonus = 0;
    let skippedAlreadyPaid = 0;
    
    const timezone = Session.getScriptTimeZone();
    const now = new Date();
    const formattedDate = Utilities.formatDate(now, timezone, "dd.MM.yyyy HH:mm:ss");
    
    Logger.log("\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    Logger.log("ğŸ¯ ĞŸĞĞ Ğ¢ĞĞ•Ğ Ğ«, Ğ”ĞĞ¡Ğ¢Ğ˜Ğ“Ğ¨Ğ˜Ğ• ĞŸĞĞ ĞĞ“Ğ (9+ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²):");
    Logger.log("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    
    for (const partnerId in partnerStats) {
      const stats = partnerStats[partnerId];
      
      // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ°
      if (stats.totalPoints >= THRESHOLD_POINTS) {
        eligibleCount++;
        
        // Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ID Ğ² Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ
        const timestamp = new Date().getTime();
        const transactionId = `MO-${targetMonth}-${partnerId}`;  // MO-2025-12-227193871
        const bonusId = `${timestamp}-MO-${partnerId}`;           // 1766471512879-MO-227193871
        
        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ğ´ÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ‚
        if (existingMonthlyBonuses.has(transactionId)) {
          Logger.log(`â­ï¸  ${stats.name} (${partnerId}): Ğ‘Ğ¾Ğ½ÑƒÑ ÑƒĞ¶Ğµ Ğ±Ñ‹Ğ» Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ĞµĞ½ Ñ€Ğ°Ğ½ĞµĞµ`);
          skippedAlreadyPaid++;
          continue;
        }
        
        // Ğ Ğ°ÑÑ‡ĞµÑ‚ Ğ¼ĞµÑÑÑ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ±Ğ¾Ğ½ÑƒÑĞ° (3% Ğ¾Ñ‚ Ğ·Ğ°Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´ĞµĞ½ĞµĞ³)
        const monthlyBonusAmount = stats.totalAmount * BONUS_PERCENT;
        
        Logger.log(`âœ… ${stats.name} (${partnerId})`);
        Logger.log(`   Ğ‘Ğ°Ğ»Ğ»Ñ‹: ${stats.totalPoints} | Ğ—Ğ°Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾: ${stats.totalAmount.toFixed(2)}â‚½`);
        Logger.log(`   ğŸ’° ĞœĞµÑÑÑ‡Ğ½Ñ‹Ğ¹ Ğ±Ğ¾Ğ½ÑƒÑ: ${monthlyBonusAmount.toFixed(2)}â‚½ (3%)`);
        Logger.log(`   ğŸ†” Transaction ID: ${transactionId}`);
        Logger.log(`   ğŸ†” Bonus ID: ${bonusId}`);
        
        // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ² bonus_transactions
        const bonusSaved = writeBonusTransaction({
          transactionId: transactionId,
          bonusId: bonusId,              // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ²Ğ½Ñ‹Ğ¹ bonus_id
          referal_id: partnerId,
          referal_name: stats.name,
          referal_level: 0,              // ĞĞµ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ğ¼Ğ¾ Ğ´Ğ»Ñ Ğ¼ĞµÑÑÑ‡Ğ½Ñ‹Ñ…
          bonus_level: "MO",             // ĞœĞµÑÑÑ‡Ğ½Ñ‹Ğ¹ Ğ±Ğ¾Ğ½ÑƒÑ (ĞºĞ°Ğº L1/L2)
          bonus_amount: monthlyBonusAmount,
          bonus_points: 0,               // Ğ‘Ğ°Ğ»Ğ»Ñ‹ ĞĞ• Ğ½Ğ°Ñ‡Ğ¸ÑĞ»ÑÑÑ‚ÑÑ
          bonus_percent: BONUS_PERCENT,
          buyer_id: partnerId,           // Ğ¡Ğ°Ğ¼ ÑĞµĞ±Ğµ "Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°Ñ‚ĞµĞ»ÑŒ"
          buyer_name: stats.name,
          buyer_level: 0,
          product_id: 0,                 // ĞĞµ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ğ¼Ğ¾
          payment_amount: stats.totalAmount, // Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ´Ğ»Ñ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ°
          status: "pending"
        });
        
        if (bonusSaved) {
          bonusesCreated++;
          totalMonthlyBonus += monthlyBonusAmount;
        }
      } else {
        Logger.log(`âŒ ${stats.name} (${partnerId}): ${stats.totalPoints} Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ² - ĞĞ• Ğ”ĞĞ¡Ğ¢Ğ˜Ğ“ Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ°`);
      }
    }
    
    Logger.log("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Ğ˜Ğ¢ĞĞ“Ğ˜
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const endTime = new Date();
    const duration = (endTime - startTime) / 1000;
    
    Logger.log("\nğŸ“Š Ğ˜Ğ¢ĞĞ“ĞĞ’ĞĞ¯ Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ:");
    Logger.log("   ğŸ“… ĞŸĞµÑ€Ğ¸Ğ¾Ğ´: " + targetMonth);
    Logger.log("   ğŸ‘¥ Ğ’ÑĞµĞ³Ğ¾ Ğ¿Ğ°Ñ€Ñ‚Ğ½ĞµÑ€Ğ¾Ğ² Ñ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾ÑÑ‚ÑŒÑ: " + Object.keys(partnerStats).length);
    Logger.log("   âœ… Ğ”Ğ¾ÑÑ‚Ğ¸Ğ³Ğ»Ğ¸ Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ° (9+ Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²): " + eligibleCount);
    Logger.log("   ğŸ’° ĞĞ°Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¾ Ğ±Ğ¾Ğ½ÑƒÑĞ¾Ğ²: " + bonusesCreated);
    Logger.log("   ğŸ’µ ĞĞ±Ñ‰Ğ°Ñ ÑÑƒĞ¼Ğ¼Ğ° Ğ±Ğ¾Ğ½ÑƒÑĞ¾Ğ²: " + totalMonthlyBonus.toFixed(2) + "â‚½");
    Logger.log("   â±ï¸  Ğ’Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ: " + duration.toFixed(2) + " ÑĞµĞº");
    Logger.log("âœ… Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ | " + endTime.toLocaleTimeString());
    Logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    
    // Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ´Ğ»Ñ processMonthSelection
    return {
      success: bonusesCreated > 0,
      eligibleCount: eligibleCount,
      bonusesCreated: bonusesCreated,
      totalMonthlyBonus: totalMonthlyBonus,
      skippedAlreadyPaid: skippedAlreadyPaid,
      partnerCount: Object.keys(partnerStats).length,
      targetMonth: targetMonth
    };
    
  } catch (error) {
    Logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    Logger.log("âŒ ĞšĞ Ğ˜Ğ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ¯ ĞĞ¨Ğ˜Ğ‘ĞšĞ:");
    Logger.log("   " + error.message);
    Logger.log("   Stack: " + error.stack);
    Logger.log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
    
    try {
      const ui = SpreadsheetApp.getUi();
      ui.alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°', 'ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğµ.\nĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ»Ğ¾Ğ³Ğ¸.', ui.ButtonSet.OK);
    } catch (e) {
      // UI Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ - Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ´ĞµĞ»Ğ°ĞµĞ¼
    }
    
    throw error;
  }
}


/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ĞœĞ•ĞĞ®: Ğ—Ğ°Ğ¿ÑƒÑĞº Ñ€Ğ°ÑÑ‡ĞµÑ‚Ğ° Ğ¼ĞµÑÑÑ‡Ğ½Ñ‹Ñ… Ğ±Ğ¾Ğ½ÑƒÑĞ¾Ğ²
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ¼ĞµÑÑÑ†Ğ°, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Ñ€Ğ°ÑÑ‡ĞµÑ‚
 */
function menuCalculateMonthlyBonus() {
  showMonthSelector();
}
